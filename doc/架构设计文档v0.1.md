# 数据管理平台 - 架构设计文档

## 文档信息
| 项          | 内容                          |
|-------------|-------------------------------|
| 文档版本    | V0.3                          |
| 关联需求    | 需求说明v0.3                  |
| 技术栈      | Python + Vue.js + SQLite      |

## 一、系统架构概览

### 1.1 架构模式
采用前后端分离的B/S架构，前端通过HTTP RESTful API与后端通信。

```
┌─────────────────────────────────────────────────┐
│                   浏览器（前端）                    │
│  Vue 3 + Element Plus + Vue Router + Axios       │
└──────────────────────┬──────────────────────────┘
                       │ HTTP/JSON (RESTful API)
┌──────────────────────┴──────────────────────────┐
│                   后端服务                         │
│  Python + Flask + JWT + bcrypt                    │
└──────────────────────┬──────────────────────────┘
                       │ SQL
┌──────────────────────┴──────────────────────────┐
│                   数据库                           │
│                   SQLite                          │
└─────────────────────────────────────────────────┘
```

### 1.2 技术选型

| 层级     | 技术         | 版本要求    | 选型理由                           |
|----------|-------------|-------------|-----------------------------------|
| 前端框架 | Vue 3        | 3.x         | 组合式API，学习曲线平缓            |
| UI组件库 | Element Plus | 最新稳定版  | 企业级组件库，与Vue 3深度集成       |
| 前端路由 | Vue Router   | 4.x         | Vue官方路由方案                    |
| HTTP客户端| Axios       | 最新稳定版  | 支持拦截器，便于统一处理Token和错误  |
| Excel处理 | SheetJS(xlsx)| 0.18+      | 前端导出/导入Excel文件               |
| 图表库    | ECharts      | 6.x         | 仪表盘图表渲染（柱状图/饼图/折线图）  |
| 拖拽排序  | vuedraggable | 4.x        | 支持列表拖拽排序                    |
| 前端构建 | Vite         | 最新稳定版  | 快速构建，开发体验好               |
| 后端框架 | Flask        | 2.x+        | 轻量级Python Web框架，易于学习      |
| 认证方案 | PyJWT        | 最新稳定版  | JWT Token生成与验证                |
| 密码加密 | bcrypt       | 最新稳定版  | 安全的密码哈希算法                  |
| 包管理   | uv           | 最新稳定版  | 高性能Python包管理工具，替代pip      |
| Python版本 | CPython    | >=3.12      | 运行时环境，uv可自动下载管理         |
| 数据库   | SQLite       | 3.x         | 零配置，文件级数据库，适合学习场景   |
| ORM      | 不使用       | -           | 直接使用sqlite3模块，降低学习门槛   |

## 二、后端架构设计

### 2.1 项目目录结构
```
server/
├── app.py                      # 应用入口，Flask实例创建与启动
├── config.py                   # 配置文件（密钥、数据库路径、Token过期时间等）
├── database.py                 # 数据库初始化与连接管理
├── pyproject.toml                  # 项目配置与依赖声明（uv管理）
├── uv.lock                         # 依赖锁定文件（uv自动生成）
├── common/                     # 公共模块
│   ├── __init__.py
│   ├── response.py             # 统一响应格式封装
│   └── auth.py                 # Token验证与权限校验装饰器
├── auth/                       # 认证模块（登录/登出/用户信息/改密）
│   ├── __init__.py
│   ├── api.py                  # 路由与接口定义
│   ├── crud.py                 # 数据库操作（查询用户、记录日志等）
│   ├── models.py              # 数据模型/字段定义
│   └── utils.py               # 模块工具函数（Token生成、密码校验等）
├── users/                      # 用户管理模块
│   ├── __init__.py
│   ├── api.py                  # 路由与接口定义
│   ├── crud.py                 # 数据库操作（用户CRUD）
│   ├── models.py              # 数据模型/字段定义
│   └── utils.py               # 模块工具函数
├── form_templates/                 # 模板管理模块（避免与Flask templates目录冲突）
│   ├── __init__.py
│   ├── api.py                  # 路由与接口定义
│   ├── crud.py                 # 数据库操作（模板CRUD）
│   ├── models.py              # 数据模型/字段定义
│   └── utils.py               # 模块工具函数（元数据校验等）
├── forms/                      # 表单数据模块
│   ├── __init__.py
│   ├── api.py                  # 路由与接口定义
│   ├── crud.py                 # 数据库操作（表单数据CRUD）
│   ├── models.py              # 数据模型/字段定义
│   └── utils.py               # 模块工具函数
├── logs/                       # 系统日志模块
│   ├── __init__.py
│   ├── api.py                  # 路由与接口定义
│   ├── crud.py                 # 数据库操作（日志查询）
│   └── models.py              # 数据模型/字段定义
└── data/
    └── app.db                  # SQLite数据库文件
```

### 2.2 核心模块设计

#### 2.2.1 数据库管理（database.py）
- 职责：数据库连接创建、表结构初始化、默认管理员账号初始化
- 使用 `sqlite3` 标准库，通过 `get_db()` 函数获取数据库连接
- 应用启动时自动执行建表语句和初始数据插入

#### 2.2.2 公共模块（common/）
- `auth.py`：`login_required` 装饰器验证JWT Token并注入用户信息；`admin_required` 装饰器额外校验admin角色。Token无效或过期返回401，权限不足返回403
- `response.py`：封装 `success(data, msg)` 和 `error(code, msg)` 函数，确保所有接口返回格式统一

#### 2.2.3 业务模块结构约定
每个业务模块（auth/users/templates/forms/logs）内部按职责分层：

| 文件       | 职责                                           |
|-----------|------------------------------------------------|
| api.py    | 定义Flask Blueprint路由，处理请求参数校验与响应   |
| crud.py   | 封装数据库SQL操作（增删改查），被api.py调用       |
| models.py | 定义数据字段常量、请求/响应字段映射               |
| utils.py  | 模块内部工具函数（如密码加密、元数据校验等）       |

#### 2.2.4 Blueprint注册

| 模块          | Blueprint前缀  | 职责                     |
|---------------|---------------|--------------------------|
| auth/api.py   | /api/auth     | 登录、登出、用户信息、改密 |
| users/api.py  | /api/users    | 用户CRUD、重置密码        |
| form_templates/api.py | /api/templates| 模板CRUD              |
| forms/api.py  | /api/forms    | 表单数据CRUD             |
| logs/api.py   | /api/logs     | 登录日志查询             |

### 2.3 数据库设计

#### 2.3.1 ER关系图
```
┌──────────┐       ┌───────────────┐       ┌─────────────┐
│   user   │1─────N│   form_data   │N─────1│form_template│
│          │       │               │       │             │
│ id (PK)  │       │ id (PK)       │       │ id (PK)     │
│ username │       │ template_id(FK)│       │ name        │
│ password │       │ user_id (FK)  │       │ remark      │
│ role     │       │ data (JSON)   │       │ meta_data   │
│ status   │       │ create_time   │       │ creator_id(FK)│
│ need_change_pwd│ │ update_time   │       │ create_time │
│ create_time│     └───────────────┘       │ update_time │
│ last_login_time│                         └──────┬──────┘
└─────┬────┘                                      │N
      │1                                          │
      ├───────────────────────────────────────────┘
      │  (user.id ← form_template.creator_id)
      │1
      │
      │N
┌─────┴────┐
│login_log │
│          │
│ id (PK)  │
│ user_id  │
│ username │
│ login_ip │
│login_status│
│login_time│
└──────────┘
```

#### 2.3.2 建表SQL
```sql
CREATE TABLE IF NOT EXISTS user (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(100) NOT NULL,
    role VARCHAR(20) NOT NULL DEFAULT 'user',
    status INTEGER NOT NULL DEFAULT 1,
    need_change_pwd INTEGER NOT NULL DEFAULT 1,
    create_time DATETIME NOT NULL DEFAULT (datetime('now','localtime')),
    last_login_time DATETIME
);

CREATE TABLE IF NOT EXISTS form_template (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(50) NOT NULL UNIQUE,
    remark VARCHAR(200),
    meta_data TEXT NOT NULL,
    creator_id INTEGER NOT NULL,
    create_time DATETIME NOT NULL DEFAULT (datetime('now','localtime')),
    update_time DATETIME NOT NULL DEFAULT (datetime('now','localtime')),
    FOREIGN KEY (creator_id) REFERENCES user(id)
);

CREATE TABLE IF NOT EXISTS form_data (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    template_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    data TEXT NOT NULL,
    create_time DATETIME NOT NULL DEFAULT (datetime('now','localtime')),
    update_time DATETIME NOT NULL DEFAULT (datetime('now','localtime')),
    FOREIGN KEY (template_id) REFERENCES form_template(id),
    FOREIGN KEY (user_id) REFERENCES user(id)
);

CREATE TABLE IF NOT EXISTS login_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    username VARCHAR(50) NOT NULL,
    login_ip VARCHAR(50) NOT NULL,
    login_status INTEGER NOT NULL DEFAULT 1,
    login_time DATETIME NOT NULL DEFAULT (datetime('now','localtime'))
);
```

### 2.4 认证流程

```
登录流程：
客户端 ──POST /api/auth/login──> 服务端
  1. 验证用户名密码
  2. 检查用户状态(status)
  3. 生成JWT Token（payload: user_id, username, role, exp）
  4. 记录登录日志
  5. 更新last_login_time
  6. 返回Token和用户信息（含need_change_pwd标识）

请求鉴权流程：
客户端 ──带Authorization Header──> 服务端
  1. login_required装饰器提取Token
  2. 验证Token签名和过期时间
  3. 解析payload获取用户信息
  4. 注入g.current_user供路由函数使用
  5. 若需admin权限，admin_required额外校验role
```

## 三、前端架构设计

### 3.1 项目目录结构
```
client/
├── index.html
├── package.json
├── vite.config.js            # Vite配置（代理后端API）
├── src/
│   ├── main.js               # 应用入口
│   ├── App.vue               # 根组件
│   ├── router/
│   │   └── index.js          # 路由配置与导航守卫
│   ├── api/                  # API请求封装
│   │   ├── request.js        # Axios实例（拦截器：Token注入、401处理）
│   │   ├── auth.js           # 认证相关API
│   │   ├── users.js          # 用户管理API
│   │   ├── templates.js      # 模板管理API
│   │   ├── forms.js          # 表单数据API
│   │   └── logs.js           # 日志API
│   ├── views/                # 页面组件
│   │   ├── Login.vue         # 登录页
│   │   ├── Layout.vue        # 主布局（顶栏+侧栏+内容区）
│   │   ├── Home.vue          # 首页（仪表盘展示）
│   │   ├── DashboardConfig.vue # 仪表盘配置页
│   │   ├── Templates.vue     # 模板管理页
│   │   ├── Forms.vue         # 表单数据页
│   │   ├── FormBrowser.vue   # 数据查询页（高级筛选+排序+导出Excel）
│   │   ├── FormSheet.vue     # 表格编辑页（Excel风格编辑）
│   │   ├── Users.vue         # 用户管理页
│   │   ├── Profile.vue       # 个人中心页
│   │   ├── Logs.vue          # 系统日志页
│   │   ├── Forbidden.vue     # 401无权限页
│   │   └── NotFound.vue      # 404页面
│   ├── components/           # 可复用组件
│   │   ├── FieldEditor.vue   # 模板字段配置编辑器
│   │   ├── DynamicForm.vue   # 动态表单渲染组件
│   │   └── DashboardChart.vue # ECharts图表封装组件（柱状图/饼图/折线图）
│   └── utils/
│       └── storage.js        # localStorage工具（Token/记住密码）
```

### 3.2 核心模块设计

#### 3.2.1 Axios请求封装（api/request.js）
- 创建Axios实例，设置baseURL
- 请求拦截器：从localStorage读取Token，注入Authorization Header
- 响应拦截器：
  - 401状态：清除Token，跳转登录页
  - 其他错误：ElMessage提示错误信息

#### 3.2.2 路由与导航守卫（router/index.js）
```
路由守卫逻辑：
1. 白名单路由（/login, /401, /404）直接放行
2. 无Token → 跳转/login
3. 有Token → 检查need_change_pwd → 若需修改密码则跳转/system/profile
4. admin专属路由 → 校验角色，非admin跳转/401
5. 通过校验 → 放行
```

#### 3.2.3 动态表单渲染（components/DynamicForm.vue）
- 核心组件：根据模板meta_data动态渲染表单
- 输入：meta_data（字段配置数组）、formData（回显数据，编辑时传入）
- 输出：表单提交事件，携带填写的数据
- 字段类型映射：
  - text → el-input
  - number → el-input-number
  - date → el-date-picker
  - radio → el-radio-group
  - checkbox → el-checkbox-group
- 自动生成表单校验规则（required字段）

#### 3.2.4 字段配置编辑器（components/FieldEditor.vue）
- 用于模板创建/编辑时配置表单字段
- 支持动态增删字段行
- 字段类型切换时动态显示/隐藏选项配置（radio/checkbox时显示选项输入）

#### 3.2.5 数据查询页（views/FormBrowser.vue）
- 选择模板后加载数据，支持多条件高级筛选
- 筛选操作符根据字段类型自动适配（文本：=、!=、like、contains；数字/日期：=、!=、>、<、>=、<=；单选/多选：=、!=、in、not_in）
- 列管理：拖拽调整列顺序、隐藏/恢复列、点击列头排序
- 导出Excel：使用SheetJS(xlsx)库，按当前筛选条件和可见列导出全部数据

#### 3.2.6 表格编辑页（views/FormSheet.vue）
- 选择模板后以Excel风格表格展示数据
- 支持直接在表格中编辑单元格数据
- 导入功能：下拉菜单提供"下载导入模板"（按当前模板字段生成表头Excel）和"导入数据"两个选项
- 导入数据校验：必填字段不能为空、数字字段必须为有效数字，校验失败弹窗显示具体行列错误

#### 3.2.7 仪表盘图表组件（components/DashboardChart.vue）
- 封装 ECharts 实例，支持柱状图（bar）、饼图（pie）、折线图（line）三种类型
- 输入：`type`（图表类型）、`data`（`[{name, value}]` 格式）
- 组件销毁时自动 dispose，监听窗口 resize 自动重绘

#### 3.2.8 仪表盘配置页（views/DashboardConfig.vue）
- 图表配置项存储于 `localStorage`（key: `dashboard_config`），无需后端接口
- 每个图表配置包含：id、title、templateId、templateName、fieldName、fieldLabel、fieldType、chartType
- 支持拖拽排序（vuedraggable）、新增/编辑/删除图表
- 统计字段支持选择模板任意字段或"记录总数（__count__）"

#### 3.2.9 首页仪表盘（views/Home.vue）
- 从 localStorage 读取图表配置，按 templateId 去重后批量请求表单数据（page_size=5000）
- 顶部多选框可按模板筛选显示的图表，未选则显示全部
- 数据处理：按字段值分组计数，多选字段展开后分别计数，最多展示前20个分组
- 数值统计类型（stat）直接显示大字号数值，其余类型渲染 DashboardChart 组件

### 3.3 状态管理
本项目规模较小，不引入Vuex/Pinia，采用以下方式管理状态：
- 用户信息：localStorage存储Token和用户基本信息，各组件通过API工具函数读取
- 页面数据：各页面组件内部管理，通过API请求获取

## 四、前后端交互设计

### 4.1 跨域处理
开发环境通过Vite的proxy配置代理API请求到后端Flask服务，避免跨域问题：
```js
// vite.config.js
server: {
  proxy: {
    '/api': {
      target: 'http://localhost:5000',
      changeOrigin: true
    }
  }
}
```

### 4.2 接口调用约定
- 前端统一通过 `api/` 目录下的模块调用后端接口
- 所有请求/响应均为JSON格式
- 分页请求统一传递 `page` 和 `page_size` 参数
- 错误处理统一在Axios响应拦截器中完成

## 五、安全设计

| 安全措施         | 实现方式                                    |
|-----------------|---------------------------------------------|
| 密码存储         | bcrypt哈希，不存储明文                       |
| 身份认证         | JWT Token，2小时过期                         |
| 接口鉴权         | 装饰器校验Token和角色                        |
| 数据隔离         | 后端按user_id过滤，普通用户仅访问自己的数据    |
| 防重复提交       | 前端按钮提交后禁用，请求完成后恢复             |
| 记住密码         | localStorage加密存储，7天有效期               |
| 首次登录改密     | need_change_pwd标识，前端路由守卫强制跳转      |

## 六、部署方案

### 6.1 开发环境
```
后端包管理：uv init → uv add flask pyjwt bcrypt
前端：npm run dev  → localhost:5173（Vite开发服务器）
后端：uv run python app.py → localhost:5000（Flask开发服务器）
前端通过Vite proxy代理 /api 请求到后端
```

### 6.2 生产环境（简化版）
```
前端：npm run build → 生成dist静态文件
后端：Flask直接托管dist静态文件 + 提供API服务
单进程部署，适合学习和演示场景
```
